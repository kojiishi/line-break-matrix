<!DOCTYPE html>
<title>Line Break Matrix</title>
<script src="../resources/fontloader.js"></script>
<style>
#menu {
  background-color:lightgray;
  border:thin solid gray;
  padding:4px;
}
#test {
  font:50px/1 testfw;
  width:1em;
}
#result {
  font:15px/1 Courier, monospace;
  white-space:pre;
}
#log {
  background-color:lightgray;
  padding:.2em;
}
</style>
<h1>Line Break Matrix</h1>
<form id=menu method=get>
  <input type=checkbox id="word-break-break-all" name="word-break" value="break-all">
  <label for="word-break-break-all">word-break: break-all</label>
  <input type=submit>
</form>
</div>
<div id="log"></div>
<div id="result"></div>
<div id="test"></div>
<script>
var testFontsize = parseFloat(getComputedStyle(test).fontSize);
testfwFont("../resources/").then(function () {
  debug("Calculating...");
  setTimeout(function () {
    run();
    log.style.display = "none";
  }, 10);
});

function run() {
  var characters = null;
  var args = location.search;
  if (args && args.length > 1) {
    args.slice(1).split("&").forEach(function (arg) {
      arg = arg.split("=", 2);
      switch (arg[0]) {
      case "code":
        characters = createCharacterArray(arg[1]);
        break;
      default:
        test.style[arg[0]] = arg[1];
        var ui = document.getElementById(arg[0] + "-" + arg[1]);
        if (ui)
          ui.checked = true;
        break;
      }
    });
  }
  if (!characters)
    characters = createCharacterArray(0x21, 0x7E);
  var matrix = getLineBreakMatrix(characters);
  dumpLineBreakMatrix(characters, matrix);
  test.textContent = "";
  var download = createJsonDownloadLink(matrix);
  if (download != null)
    menu.appendChild(download);
}

function createCharacterArray(begin, last) {
  if (!last) {
    var range = begin.split("-").map(function (v) { return parseInt(v, 16); });
    begin = range[0];
    last = range[1];
  }
  var count = last - begin + 1;
  return Array.apply(0, Array(count)).map(function(v, i) {
    return String.fromCharCode(begin + i); })
}

function getLineBreakMatrix(characters) {
  var matrix = [];
  for (var lastIndex = 0; lastIndex < characters.length; lastIndex++) {
    var last = characters[lastIndex];
    var canBreakBefore = [];
    for (var currentIndex = 0; currentIndex < characters.length; currentIndex++) {
      var current = characters[currentIndex];
      canBreakBefore.push(canBreakBetween(last, current));
    }
    matrix.push(canBreakBefore);
  }
  return matrix;
}

function canBreakBetween(last, current) {
  test.textContent = last + current;
  return test.offsetHeight / testFontsize > 1.9;
}

function dumpLineBreakMatrix(characters, matrix) {
  var header = [];
  for (var i = 0; i < matrix.length; i++)
    header.push(characters[i]);
  var rows = ["        " + header.join("")];
  for (var i = 0; i < matrix.length; i++) {
    rows.push(
      toHex(characters[i].charCodeAt(0)) + " " +
      characters[i] + " " +
      matrix[i].map(function (canBreak) {
        return canBreak ? "/" : "X";
      }).join(String.fromCharCode(0x200C)));
  }
  result.textContent = rows.join("\n");
}

function createJsonDownloadLink(obj) {
  var a = document.createElement("a");
  if (!("download" in a))
    return null;
  a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(obj));
  a.download = "line-break-matrix.json";
  a.textContent = "Download JSON"
  return a;
}

function toHex(value) {
  var str = value.toString(16).toUpperCase();
  var pad = "00000";
  return pad.substring(0, pad.length - str.length) + str;
}

function debug(text) {
  var div = document.createElement("div");
  div.appendChild(document.createTextNode(text));
  log.appendChild(div);
}
</script>
